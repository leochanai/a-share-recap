---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import ReportCard from '../components/ReportCard.astro';

const reports = (await getCollection('reports'))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// 提取大盘概览数据
function extractMarketOverview(body: string) {
  const lines = body.split('\n');
  const indices: { name: string; close: string; change: string }[] = [];
  let volume = '';

  // 找到大盘概览表格
  let inTable = false;
  for (const line of lines) {
    if (line.includes('| 指数 |')) {
      inTable = true;
      continue;
    }
    if (inTable && line.startsWith('|---')) continue;
    if (inTable && line.startsWith('|')) {
      const parts = line.split('|').map(s => s.trim()).filter(Boolean);
      if (parts.length >= 3) {
        indices.push({
          name: parts[0],
          close: parts[1],
          change: parts[2]
        });
      }
    } else if (inTable) {
      inTable = false;
    }

    // 提取成交额
    if (line.includes('两市合计')) {
      const match = line.match(/两市合计[：:]\s*([\d.]+)\s*万亿/);
      if (match) {
        volume = match[1] + '万亿';
      }
    }
  }

  return { indices, volume };
}
---

<BaseLayout title="A股每日复盘">
  <!-- Hero Section -->
  <section class="mb-12">
    <div class="mb-6">
      <h1 class="font-display text-4xl sm:text-5xl font-semibold leading-tight mb-4" style="color: var(--color-text-primary);">
        洞察市场脉搏
      </h1>
      <p class="text-lg max-w-xl" style="color: var(--color-text-secondary);">
        追踪资金流向，把握投资先机。
      </p>
    </div>
  </section>

  <!-- Report Cards -->
  <section>
    <h2 class="font-mono text-xs uppercase tracking-widest mb-6" style="color: var(--color-text-muted);">
      历史报告 / Archive
    </h2>

    {reports.length === 0 ? (
      <div class="py-16 text-center" style="color: var(--color-text-muted);">
        <p class="font-mono text-sm">暂无复盘报告</p>
      </div>
    ) : (
      <div class="grid gap-6 sm:grid-cols-1 lg:grid-cols-2">
        {reports.map((report, index) => {
          const overview = extractMarketOverview(report.body);
          return (
            <div style={`animation-delay: ${index * 0.05}s`} class="animate-fade-in">
              <ReportCard report={report} overview={overview} />
            </div>
          );
        })}
      </div>
    )}
  </section>
</BaseLayout>
