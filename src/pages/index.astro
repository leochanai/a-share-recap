---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import ReportCard from '../components/ReportCard.astro';

const reports = (await getCollection('reports'))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// 提取大盘概览数据
function extractMarketOverview(body: string) {
  const lines = body.split('\n');
  const indices: { name: string; close: string; change: string }[] = [];
  let volume = '';

  // 找到大盘概览表格
  let inTable = false;
  for (const line of lines) {
    if (line.includes('| 指数 |')) {
      inTable = true;
      continue;
    }
    if (inTable && line.startsWith('|---')) continue;
    if (inTable && line.startsWith('|')) {
      const parts = line.split('|').map(s => s.trim()).filter(Boolean);
      if (parts.length >= 3) {
        indices.push({
          name: parts[0],
          close: parts[1],
          change: parts[2]
        });
      }
    } else if (inTable) {
      inTable = false;
    }

    // 提取成交额
    if (line.includes('两市合计')) {
      const match = line.match(/两市合计[：:]\s*([\d.]+)\s*万亿/);
      if (match) {
        volume = match[1] + '万亿';
      }
    }
  }

  return { indices, volume };
}
---

<BaseLayout title="A股每日复盘">
  <!-- Hero Section -->
  <section class="mb-12">
    <div class="mb-6">
      <h1 class="font-display text-4xl sm:text-5xl font-semibold leading-tight mb-4" style="color: var(--color-text-primary);">
        洞察市场脉搏
      </h1>
      <p class="text-lg max-w-xl" style="color: var(--color-text-secondary);">
        追踪资金流向，把握投资先机。
      </p>
      <p class="mt-3 text-sm font-mono flex items-center gap-2" style="color: var(--color-text-muted);">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        交易日 17:00 自动生成复盘报告
      </p>
    </div>
  </section>

  <!-- Report Cards -->
  <section>
    <h2 class="font-mono text-xs uppercase tracking-widest mb-6 flex items-center gap-2" style="color: var(--color-text-muted);">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
      </svg>
      历史报告 / Archive
    </h2>

    {reports.length === 0 ? (
      <div class="py-16 text-center" style="color: var(--color-text-muted);">
        <svg class="mx-auto mb-4 opacity-30" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        <p class="font-mono text-sm">暂无复盘报告</p>
        <p class="text-xs mt-2 opacity-60">交易日收盘后将自动生成</p>
      </div>
    ) : (
      <div class="grid gap-6 sm:grid-cols-1 lg:grid-cols-2">
        {reports.map((report, index) => {
          const overview = extractMarketOverview(report.body);
          return (
            <div style={`animation-delay: ${index * 0.05}s`} class="animate-fade-in">
              <ReportCard report={report} overview={overview} />
            </div>
          );
        })}
      </div>
    )}
  </section>
</BaseLayout>
