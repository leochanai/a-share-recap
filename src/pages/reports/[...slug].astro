---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import DateNav from '../../components/DateNav.astro';

export async function getStaticPaths() {
  const reports = await getCollection('reports');
  return reports.map((report) => ({
    params: { slug: report.slug },
    props: { report },
  }));
}

const { report } = Astro.props;
const { Content } = await report.render();

const allReports = (await getCollection('reports'))
  .sort((a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime());
const currentIndex = allReports.findIndex(r => r.slug === report.slug);
const prevReport = currentIndex > 0 ? allReports[currentIndex - 1] : null;
const nextReport = currentIndex < allReports.length - 1 ? allReports[currentIndex + 1] : null;

const dateObj = new Date(report.data.date);
const formattedDate = dateObj.toLocaleDateString('zh-CN', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  weekday: 'long'
});
---

<BaseLayout title={`${report.data.date} 市场复盘`}>
  <!-- Report Header -->
  <header class="mb-12">
    <div class="flex items-center gap-3 mb-6">
      <a href="/" class="font-mono text-xs uppercase tracking-widest hover:text-[var(--color-accent)] transition-colors" style="color: var(--color-text-muted);">
        ← 返回目录
      </a>
    </div>

    <div class="flex flex-wrap items-baseline gap-4 mb-4">
      <time class="font-mono text-sm" style="color: var(--color-accent);">
        {formattedDate}
      </time>
      <div class="flex gap-2">
        {report.data.tags.map((tag) => (
          <span class="font-mono text-xs px-2 py-0.5" style="background-color: var(--color-bg-tertiary); color: var(--color-text-muted);">
            {tag}
          </span>
        ))}
      </div>
    </div>
  </header>

  <!-- Report Content -->
  <article class="prose prose-lg max-w-none">
    <Content />
  </article>

  <!-- Navigation -->
  <DateNav prev={prevReport} next={nextReport} />
</BaseLayout>
